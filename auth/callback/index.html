<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pantry & Plate - Continue in App</title>
    <style>
      :root {
        --paper: #f5ead9;
        --ink: #3f2b1c;
        --ink-soft: #5b4130;
        --accent: #d17e2f;
        --line: rgba(76, 50, 30, 0.25);
        --line-strong: rgba(76, 50, 30, 0.45);
        --card: rgba(255, 255, 255, 0.58);
        --warn-bg: rgba(255, 236, 209, 0.78);
        --warn-line: rgba(209, 126, 47, 0.35);
        --ok-bg: rgba(225, 248, 233, 0.84);
        --ok-line: rgba(63, 138, 85, 0.45);
        --err-bg: rgba(255, 226, 223, 0.88);
        --err-line: rgba(186, 69, 69, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Avenir Next", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 12% -8%, #ffe8b7 0, transparent 40%),
          radial-gradient(circle at 100% 0, #f3c694 0, transparent 36%),
          var(--paper);
      }

      .layout {
        max-width: 760px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        border-radius: 24px;
        border: 1px solid var(--line);
        background: var(--card);
        box-shadow:
          0 18px 38px rgba(60, 34, 13, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.52);
        padding: 22px;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.2rem, 1rem + 1vw, 1.7rem);
      }

      p {
        margin: 12px 0 0;
        color: var(--ink-soft);
        line-height: 1.45;
      }

      .status {
        margin-top: 14px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--warn-line);
        background: var(--warn-bg);
        font-weight: 600;
      }

      .status.ok {
        border-color: var(--ok-line);
        background: var(--ok-bg);
      }

      .status.error {
        border-color: var(--err-line);
        background: var(--err-bg);
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 16px;
      }

      button,
      .button-link {
        border: 0;
        border-radius: 14px;
        font: inherit;
        font-weight: 800;
        cursor: pointer;
        text-decoration: none;
        padding: 11px 14px;
      }

      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .button-primary {
        background: linear-gradient(135deg, #d9893d, #b6661f);
        color: #fffdf9;
      }

      .button-secondary {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.62);
        color: var(--ink);
      }

      .block {
        margin-top: 16px;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.48);
      }

      .block-title {
        margin: 0;
        font-size: 0.82rem;
        letter-spacing: 0.04em;
        font-weight: 800;
        text-transform: uppercase;
        color: #795239;
      }

      code {
        display: block;
        margin-top: 8px;
        word-break: break-all;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.78rem;
        color: #4b2f1d;
      }

      .field {
        margin-top: 12px;
      }

      .field label {
        display: block;
        font-size: 0.88rem;
        font-weight: 800;
        color: #5a3e2b;
      }

      .field input {
        width: 100%;
        margin-top: 6px;
        border: 1px solid var(--line-strong);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.82);
        padding: 10px 12px;
        font: inherit;
        color: var(--ink);
      }

      .field input:focus {
        outline: 2px solid rgba(209, 126, 47, 0.32);
        border-color: rgba(209, 126, 47, 0.8);
      }

      .small {
        margin-top: 8px;
        font-size: 0.82rem;
        color: #6d4f3a;
      }

      .desktop-help {
        margin-top: 16px;
      }

      .desktop-help[hidden] {
        display: none;
      }

      .desktop-help ol {
        margin: 8px 0 0;
        padding-left: 1.2rem;
        color: var(--ink-soft);
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section class="card">
        <h1 id="headline">Continue in Pantry & Plate</h1>
        <p>
          This secure link can continue sign-in or password recovery in Pantry & Plate.
        </p>

        <div id="status" class="status">Preparing secure handoff...</div>

        <form id="resetForm" class="block" hidden>
          <p class="block-title">Reset password on this device</p>
          <p class="small">Use at least 8 characters.</p>
          <div class="field">
            <label for="newPassword">New password</label>
            <input id="newPassword" type="password" autocomplete="new-password" />
          </div>
          <div class="field">
            <label for="confirmPassword">Confirm password</label>
            <input id="confirmPassword" type="password" autocomplete="new-password" />
          </div>
          <div class="row">
            <button id="savePasswordBtn" class="button-primary" type="submit">
              Save new password
            </button>
          </div>
        </form>

        <div id="appActions" class="row">
          <a id="openBtn" class="button-link button-primary" href="#">
            Open Pantry & Plate
          </a>
          <button id="showWebResetBtn" class="button-secondary" type="button" hidden>
            Reset here instead
          </button>
          <button id="copyAppLinkBtn" class="button-secondary" type="button">
            Copy app link
          </button>
          <button id="copyPhoneUrlBtn" class="button-secondary" type="button">
            Copy current link
          </button>
        </div>

        <div class="block">
          <p class="block-title">Current link</p>
          <code id="phoneUrlText"></code>
        </div>

        <div class="block">
          <p class="block-title">App deep link</p>
          <code id="appUrlText"></code>
        </div>

        <div id="desktopHelp" class="desktop-help" hidden>
          <p>
            If you prefer the app flow, open this link on your phone and continue there.
          </p>
          <ol>
            <li>Open Pantry & Plate on your phone.</li>
            <li>Open your reset email link, or paste the copied current link into mobile browser.</li>
            <li>Complete the flow in the app.</li>
          </ol>
          <p>Need help? Visit <a href="/support.html">Support</a>.</p>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const SUPABASE_URL = "https://api.pantryandplate.app";
        const SUPABASE_ANON_KEY = "sb_publishable_rc-WgqGuUSihr5yK8uS-ZQ_YV5FklsD";
        const MIN_PASSWORD_LENGTH = 8;

        const statusEl = document.getElementById("status");
        const headlineEl = document.getElementById("headline");
        const openBtn = document.getElementById("openBtn");
        const showWebResetBtn = document.getElementById("showWebResetBtn");
        const copyAppLinkBtn = document.getElementById("copyAppLinkBtn");
        const copyPhoneUrlBtn = document.getElementById("copyPhoneUrlBtn");
        const phoneUrlText = document.getElementById("phoneUrlText");
        const appUrlText = document.getElementById("appUrlText");
        const desktopHelp = document.getElementById("desktopHelp");
        const resetForm = document.getElementById("resetForm");
        const newPasswordEl = document.getElementById("newPassword");
        const confirmPasswordEl = document.getElementById("confirmPassword");
        const savePasswordBtn = document.getElementById("savePasswordBtn");

        function setStatus(message, tone) {
          statusEl.textContent = message;
          statusEl.classList.remove("ok", "error");
          if (tone === "ok") statusEl.classList.add("ok");
          if (tone === "error") statusEl.classList.add("error");
        }

        function maskForDisplay(url) {
          return url.length > 220 ? url.slice(0, 216) + "..." : url;
        }

        async function copyText(text, successMessage) {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
            } else {
              const node = document.createElement("textarea");
              node.value = text;
              node.setAttribute("readonly", "");
              node.style.position = "fixed";
              node.style.opacity = "0";
              document.body.appendChild(node);
              node.select();
              document.execCommand("copy");
              document.body.removeChild(node);
            }
            setStatus(successMessage, "ok");
          } catch (_err) {
            setStatus("Could not copy automatically. Select and copy the text manually.", "error");
          }
        }

        const pageUrl = new URL(window.location.href);
        const queryAndHash = new URLSearchParams(pageUrl.search);
        const hash = pageUrl.hash ? pageUrl.hash.substring(1) : "";

        if (hash) {
          const hashParams = new URLSearchParams(hash);
          hashParams.forEach((value, key) => {
            queryAndHash.append(key, value);
          });
        }

        const params = queryAndHash.toString();
        const deepLinkBase = "pantryandplate://login-callback/";
        const deepLink = params ? `${deepLinkBase}?${params}` : deepLinkBase;
        const flowType = (queryAndHash.get("type") || "").toLowerCase();
        const isRecovery = flowType === "recovery";
        const isMobile = /android|iphone|ipad|ipod/i.test(navigator.userAgent || "");
        const accessToken = (queryAndHash.get("access_token") || "").trim();
        const authCode = (queryAndHash.get("code") || "").trim();
        const state = (queryAndHash.get("state") || "").trim();

        const errorDescription =
          queryAndHash.get("error_description") || queryAndHash.get("error");

        if (isRecovery) {
          headlineEl.textContent = "Reset your password";
        }

        openBtn.href = deepLink;
        phoneUrlText.textContent = maskForDisplay(pageUrl.toString());
        appUrlText.textContent = maskForDisplay(deepLink);

        copyAppLinkBtn.addEventListener("click", function () {
          copyText(deepLink, "Copied app link.");
        });

        copyPhoneUrlBtn.addEventListener("click", function () {
          copyText(pageUrl.toString(), "Copied current link.");
        });

        function tryOpenApp() {
          window.location.href = deepLink;
        }

        if (errorDescription) {
          setStatus(`Link error: ${errorDescription}`, "error");
        }

        if (isRecovery && accessToken) {
          if (isMobile) {
            showWebResetBtn.hidden = false;
            showWebResetBtn.addEventListener("click", function () {
              resetForm.hidden = false;
              desktopHelp.hidden = true;
              showWebResetBtn.hidden = true;
              setStatus("Reset in browser mode enabled. Set your new password below.", "ok");
            });

            if (!errorDescription) {
              setStatus("Opening Pantry & Plate to continue password reset...", "");
            }
            window.setTimeout(tryOpenApp, 80);
            window.setTimeout(function () {
              if (!errorDescription) {
                setStatus(
                  "If the app did not open, tap \"Open Pantry & Plate\" or use \"Reset here instead\".",
                  "",
                );
              }
            }, 1300);
          } else {
            resetForm.hidden = false;
            if (!errorDescription) {
              setStatus("Recovery link accepted. Set your new password below.", "ok");
            }
          }

          let submitting = false;
          resetForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            if (submitting) return;

            const password = (newPasswordEl.value || "").trim();
            const confirm = (confirmPasswordEl.value || "").trim();

            if (password.length < MIN_PASSWORD_LENGTH) {
              setStatus(`Password must be at least ${MIN_PASSWORD_LENGTH} characters.`, "error");
              return;
            }
            if (password !== confirm) {
              setStatus("Passwords do not match.", "error");
              return;
            }

            submitting = true;
            savePasswordBtn.disabled = true;
            setStatus("Saving your new password...", "");

            try {
              const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  apikey: SUPABASE_ANON_KEY,
                  Authorization: `Bearer ${accessToken}`,
                },
                body: JSON.stringify({ password }),
              });

              let payload = null;
              try {
                payload = await response.json();
              } catch (_err) {
                payload = null;
              }

              if (!response.ok) {
                const msg =
                  (payload && (payload.msg || payload.error_description || payload.error)) ||
                  "Could not update password. The link may be expired.";
                throw new Error(msg);
              }

              fetch(`${SUPABASE_URL}/auth/v1/logout`, {
                method: "POST",
                headers: {
                  apikey: SUPABASE_ANON_KEY,
                  Authorization: `Bearer ${accessToken}`,
                },
              }).catch(() => {});

              setStatus("Password updated. You can now sign in with your new password.", "ok");
              resetForm.reset();
              if (window.history && window.history.replaceState) {
                window.history.replaceState({}, document.title, "/auth/callback/");
              }
            } catch (error) {
              setStatus(error.message || "Could not update password.", "error");
            } finally {
              submitting = false;
              savePasswordBtn.disabled = false;
            }
          });
        } else {
          desktopHelp.hidden = false;
          if (!errorDescription) {
            if (isRecovery) {
              setStatus(
                "This recovery link is missing a usable token. Request a new reset email and try again.",
                "error",
              );
            } else if (authCode && state.isEmpty) {
              setStatus(
                "This link contains an app-issued auth code and must be completed in the app flow. For desktop reset, request a new reset email from the latest app build.",
                "error",
              );
            } else {
              setStatus("Continue sign-in in the app, or copy this link to your phone.", "");
            }
          }
        }

        if (isMobile) {
          if (!(isRecovery && accessToken)) {
            window.setTimeout(tryOpenApp, 80);
            window.setTimeout(function () {
              setStatus("If the app did not open, tap \"Open Pantry & Plate\".", "");
            }, 1300);
          }
        }
      })();
    </script>
  </body>
</html>
